<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <title>AIzen â€“ Alle Vokabeln</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/png" href="AIzen.png">
</head>

<body>

    <!-- Topbar Navigation -->
    <header class="topbar">
        <div class="topbar-left">
            <img src="AIzen.png" class="topbar-logo" alt="AIzen Logo">
            <span class="topbar-title">AIzen Vokabeltrainer</span>
        </div>

        <nav class="topbar-nav">
            <a href="vocab3.html" class="nav-link">
                <span class="nav-icon">âœï¸</span>
                <span>Trainer</span>
            </a>
            <a href="vocab_show.html" class="nav-link active">
                <span class="nav-icon">ğŸ“š</span>
                <span>Alle Vokabeln</span>
            </a>
            <a href="dashboard.html" class="nav-link">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Dashboard</span>
            </a>
            <a href="durchschnitt/durchschnitt.html" class="nav-link">
                <span class="nav-icon">ğŸ†</span>
                <span>Dashboard</span>
            </a>
        </nav>
    </header>

    <div class="container">

        <!-- Generated Text Section -->
        <div class="text-display-card">
            <h2 class="section-heading">ğŸ“– Letzte generierte Geschichte</h2>

            <!-- French Text -->
            <div class="text-section">
                <div class="section-header">
                    <h3>ğŸ‡«ğŸ‡· FranzÃ¶sischer Text</h3>
                    <button id="ttsBtn" class="icon-btn" title="Text vorlesen">
                        ğŸ”Š
                    </button>
                </div>
                <div id="generatedText" class="text-content french-text">
                    Noch keine Geschichte generiert. Gehe zum Trainer und erstelle deine erste Geschichte!
                </div>
            </div>

            <!-- German Translation (Collapsible) -->
            <div class="translation-section">
                <button id="translationToggle" class="translation-toggle">
                    <span class="toggle-icon">â–¶</span>
                    <span>Deutsche Ãœbersetzung anzeigen</span>
                </button>
                <div id="translationContent" class="translation-content hidden">
                    <div class="text-section translation-box">
                        <h3>ğŸ‡©ğŸ‡ª Deutsche Ãœbersetzung</h3>
                        <div id="translatedText" class="text-content">
                            Keine Ãœbersetzung verfÃ¼gbar.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="vocab2.html" class="btn btn-primary">
                    <span class="btn-icon">â†»</span>
                    Neue Geschichte erstellen
                </a>
                <button id="copyFrenchBtn" class="btn btn-secondary">
                    <span class="btn-icon">ğŸ“‹</span>
                    FranzÃ¶sisch kopieren
                </button>
                <button id="copyGermanBtn" class="btn btn-secondary">
                    <span class="btn-icon">ğŸ“‹</span>
                    Deutsch kopieren
                </button>
            </div>
        </div>

        <!-- All Vocabs Section -->
        <div class="vocab-list-card">
            <div class="card-header">
                <h2 class="section-heading">ğŸ“š Alle gespeicherten Vokabeln</h2>
                <div class="header-actions">
                    <button class="btn btn-primary" id="loadVocab">
                        <span class="btn-icon">ğŸ”„</span>
                        Vokabeln laden
                    </button>
                    <button class="btn btn-secondary" id="exportBtn">
                        <span class="btn-icon">ğŸ“¥</span>
                        CSV Export
                    </button>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" id="filterInput" class="search-input"
                    placeholder="ğŸ” Filtern nach FranzÃ¶sisch, Englisch oder Phrase...">
                <div class="search-stats" id="searchStats">
                    <span id="resultCount">0 Vokabeln</span>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="vocab-table vocab-display-table" id="vocabTable">
                    <thead>
                        <tr>
                            <th>FranÃ§ais</th>
                            <th>Anglais</th>
                            <th>Phrase</th>
                            <th>Datum</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="loading-row">
                            <td colspan="4">Klicke auf "Vokabeln laden" um deine Vokabeln anzuzeigen</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const WEBHOOK_GET_ALL = "https://n8n.srv1220381.hstgr.cloud/webhook/65902228-7703-4dad-a898-ab8cfd33c107";
        const tbody = document.querySelector("#vocabTable tbody");
        const filterInput = document.getElementById('filterInput');
        const resultCount = document.getElementById('resultCount');
        let vocabData = [];


        /* ============ Load Generated Text ============ */
        function loadGeneratedText() {
            const generatedText = localStorage.getItem('generatedText');
            const translatedText = localStorage.getItem('translatedText');
            const lastDate = localStorage.getItem('lastGeneratedDate');

            if (generatedText) {
                document.getElementById('generatedText').innerText = generatedText;
            }

            if (translatedText) {
                document.getElementById('translatedText').innerText = translatedText;
            }

            if (lastDate) {
                const dateStr = new Date(lastDate).toLocaleString('de-DE');
                document.querySelector('.text-display-card .section-heading').innerHTML =
                    `ğŸ“– Letzte generierte Geschichte <small style="font-size:0.7em;opacity:0.7;">(${dateStr})</small>`;
            }
        }

        /* ============ Translation Toggle ============ */
        const translationToggle = document.getElementById('translationToggle');
        const translationContent = document.getElementById('translationContent');
        const toggleIcon = translationToggle.querySelector('.toggle-icon');

        translationToggle.addEventListener('click', () => {
            const isHidden = translationContent.classList.contains('hidden');

            if (isHidden) {
                translationContent.classList.remove('hidden');
                toggleIcon.textContent = 'â–¼';
                translationToggle.querySelector('span:last-child').textContent = 'Deutsche Ãœbersetzung verbergen';
            } else {
                translationContent.classList.add('hidden');
                toggleIcon.textContent = 'â–¶';
                translationToggle.querySelector('span:last-child').textContent = 'Deutsche Ãœbersetzung anzeigen';
            }
        });

        /* ============ French TTS ============ */
        const ttsBtn = document.getElementById('ttsBtn');
        ttsBtn.addEventListener('click', () => {
            const text = document.getElementById('generatedText').innerText;

            if (text === "Noch keine Geschichte generiert. Gehe zum Trainer und erstelle deine erste Geschichte!") {
                alert("Keine Geschichte zum Vorlesen verfÃ¼gbar.");
                return;
            }

            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.9;
                utterance.pitch = 1;

                ttsBtn.textContent = 'â¸';
                utterance.onend = () => {
                    ttsBtn.textContent = 'ğŸ”Š';
                };

                speechSynthesis.speak(utterance);
            } else {
                alert('Text-to-Speech wird von deinem Browser nicht unterstÃ¼tzt.');
            }
        });

        /* ============ Copy to Clipboard ============ */
        document.getElementById('copyFrenchBtn').addEventListener('click', () => {
            const text = document.getElementById('generatedText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('FranzÃ¶sischer Text in Zwischenablage kopiert! âœ“');
            });
        });

        document.getElementById('copyGermanBtn').addEventListener('click', () => {
            const text = document.getElementById('translatedText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Deutsche Ãœbersetzung in Zwischenablage kopiert! âœ“');
            });
        });

        /* ============ Render Vocab Table ============ */
        function renderTable(data) {
            tbody.innerHTML = "";
            if (!data.length) {
                tbody.innerHTML = "<tr><td colspan='4' class='empty-state'>Keine EintrÃ¤ge gefunden</td></tr>";
                resultCount.textContent = "0 Vokabeln";
                return;
            }

            resultCount.textContent = `${data.length} ${data.length === 1 ? 'Vokabel' : 'Vokabeln'}`;

            data.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><strong>${r.francais || '-'}</strong></td>
                    <td>${r.anglais || '-'}</td>
                    <td><em>${r.Phrase || '-'}</em></td>
                    <td>${r.Timestamp ? new Date(r.Timestamp).toLocaleDateString('de-DE') : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        /* ============ Load Vocabs ============ */
        document.getElementById('loadVocab').addEventListener('click', () => {
            tbody.innerHTML = "<tr class='loading-row'><td colspan='4'>Lade Vokabeln...</td></tr>";
            fetch(WEBHOOK_GET_ALL)
                .then(res => res.json())
                .then(data => {
                    vocabData = data.rows || [];
                    renderTable(vocabData);
                })
                .catch(err => {
                    tbody.innerHTML = "<tr class='error-row'><td colspan='4'>âŒ Fehler beim Laden der Vokabeln</td></tr>";
                    console.error(err);
                });
        });

        /* ============ Filter Vocabs ============ */
        filterInput.addEventListener('input', () => {
            const filter = filterInput.value.toLowerCase();
            const filtered = vocabData.filter(r =>
                (r.francais && r.francais.toLowerCase().includes(filter)) ||
                (r.anglais && r.anglais.toLowerCase().includes(filter)) ||
                (r.Phrase && r.Phrase.toLowerCase().includes(filter))
            );
            renderTable(filtered);
        });

        /* ============ CSV Export ============ */
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (!vocabData.length) {
                alert("Keine Vokabeln zum Exportieren. Lade zuerst die Vokabeln.");
                return;
            }

            const csv = [
                ['FranÃ§ais', 'Anglais', 'Phrase', 'Datum'],
                ...vocabData.map(r => [
                    r.francais || '',
                    r.anglais || '',
                    r.Phrase || '',
                    r.Timestamp ? new Date(r.Timestamp).toLocaleDateString('de-DE') : ''
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `aizen_vokabeln_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });

        /* ============ Load on Page Load ============ */
        window.addEventListener('DOMContentLoaded', () => {
            loadGeneratedText();
        });

        /* ============ Stop TTS on unload ============ */
        window.addEventListener('beforeunload', () => {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        });
    </script>


</body>

</html>